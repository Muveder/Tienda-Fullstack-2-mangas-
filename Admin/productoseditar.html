<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Producto - Admin</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="admin-container">
  <aside class="sidebar">
    <h2>Panel Productos</h2>
    <ul>
      <li><a href="productosmostrar.html">Mostrar Productos</a></li>
      <li><a href="crear-producto.html">Nuevo Producto</a></li>
    </ul>
  </aside>

  <main class="admin-main">
    <h1>Editar Producto</h1>
    <form id="form-editar-producto">
      <label for="codigo">Código Producto</label>
      <input type="text" id="codigo" name="codigo" minlength="3" required>

      <label for="nombre">Nombre</label>
      <input type="text" id="nombre" name="nombre" maxlength="100" required>

      <label for="descripcion">Descripción</label>
      <textarea id="descripcion" name="descripcion" maxlength="500"></textarea>

      <label for="precio">Precio</label>
      <input type="number" id="precio" name="precio" min="0" step="0.01" required>

      <label for="stock">Stock</label>
      <input type="number" id="stock" name="stock" min="0" step="1" required>

      <label for="stockCritico">Stock Crítico</label>
      <input type="number" id="stockCritico" name="stockCritico" min="0" step="1">

      <label for="categoria">Categoría</label>
      <select id="categoria" name="categoria" required>
        <option value="" disabled selected>Seleccione categoría</option>
        <option value="Electrónica">Electrónica</option>
        <option value="Ropa">Ropa</option>
        <option value="Hogar">Hogar</option>
      </select>

      <label for="imagen">Imagen (archivo)</label>
      <input type="file" id="imagen" name="imagen" accept="image/*">

      <button type="submit">Guardar Cambios</button>
    </form>
  </main>
</div>

<script src="../js/productos.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const formEditar = document.getElementById('form-editar-producto');
  const idEditar = parseInt(localStorage.getItem('editarProductoId'));
  const producto = obtenerProducto(idEditar);

  if (!producto) {
    alert('Producto no encontrado');
    window.location.href = 'productosmostrar.html';
    return;
  }

  // Rellenar formulario con datos existentes
  formEditar.codigo.value = producto.codigo;
  formEditar.nombre.value = producto.nombre;
  formEditar.descripcion.value = producto.descripcion || '';
  formEditar.precio.value = producto.precio;
  formEditar.stock.value = producto.stock;
  formEditar.stockCritico.value = producto.stockCritico || '';
  formEditar.categoria.value = producto.categoria;

  formEditar.addEventListener('submit', e => {
    e.preventDefault();

    const datos = {
      codigo: formEditar.codigo.value.trim(),
      nombre: formEditar.nombre.value.trim(),
      descripcion: formEditar.descripcion.value.trim(),
      precio: parseFloat(formEditar.precio.value),
      stock: parseInt(formEditar.stock.value),
      stockCritico: parseInt(formEditar.stockCritico.value) || null,
      categoria: formEditar.categoria.value
    };

    const archivo = formEditar.imagen.files[0];
    if (archivo) {
      const reader = new FileReader();
      reader.onload = function () {
        datos.imagen = reader.result;
        actualizarProducto(idEditar, datos);
        alert('Producto actualizado ✅');
        localStorage.removeItem('editarProductoId');
        window.location.href = 'productosmostrar.html';
      };
      reader.readAsDataURL(archivo);
    } else {
      datos.imagen = producto.imagen || '';
      actualizarProducto(idEditar, datos);
      alert('Producto actualizado ✅');
      localStorage.removeItem('editarProductoId');
      window.location.href = 'productosmostrar.html';
    }
  });
});
</script>
</body>
</html>
